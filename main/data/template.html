<hr id="puset-interpreter-template" />

<template id="settings">
    <style>
        dialog {
            user-select: none;
            border: none;
            outline: none;
            padding: 0;
            border-radius: 0.5rem;
            box-shadow: rgba(138, 122, 122, 0.8) 1px 1px 4px 0px;
        }

        .dialog-box {
            width: 900px;
            height: 600px;
        }

        .menu-list {
            overflow-y: auto;
            margin: 0;
            padding: 0;
            max-width: 50%;
            min-width: 300px;
            background-color: var(--background-menu-list);
            font-weight: bolder;
        }

        .menu-list>li {
            overflow: hidden;
            width: 100%;
            height: 3rem;
            font-size: 1.2rem;
            line-height: 3rem;
            cursor: pointer;
        }

        .menu-list>li:hover {
            background-color: var(--background-menu-list-hover);
        }

        .menu-list>li>.selected {
            width: 4px;
        }

        .menu-list>li.light>.selected {
            margin: .5rem 0;
            background-color: var(--background-switch-select);
        }

        .menu-list>li>.icon {
            width: 3rem;
            text-align: center;
        }

        #settings>div>div>div.menu-title {
            position: relative;
            line-height: 4rem;
            text-align: center;
            font-size: larger;
            font-weight: bolder;
        }

        #settings>div>div>div.menu-title>a.close {
            position: absolute;
            width: 4rem;
            height: 4rem;
            top: 0;
            right: 0;
        }

        #settings>div>div>div.menu-title>a>i {
            width: 2.6rem;
            height: 2.6rem;
            line-height: 2.6rem;
            border-radius: 50%;
            transition: transform 200ms ease-in-out;
        }

        #settings>div>div>div.menu-title>a:hover>i {
            background-color: #ddd;
            transform: rotate(90deg);
        }

        #settings>div>div>div.fill>div.content {
            overflow: hidden scroll;
        }
    </style>
    <dialog id="settings">
        <div class="flex-horizontal dialog-box">
            <ul class="menu-list">
                <li v-hide class="flex-horizontal">
                    <span class="selected"></span>
                    <span class="icon"></span>
                    <span class="text fill"></span>
                </li>
            </ul>
            <div class="fill flex-vertical">
                <div class="menu-title">
                    <span class="title">常规设置</span>
                    <a class="close" title="Close"><i class="fa-solid fa-xmark-large"></i></a>
                </div>
                <div class="fill">
                    <div class="view content"></div>
                </div>
            </div>
        </div>
    </dialog>
    <script>
        return function (target) {
            const dialog = target.querySelector("dialog");
            dialog.querySelector("a.close").addEventListener("click", function () {
                dialog.close();
            });
        }
    </script>
</template>

<template id="layer">
    <style>
        .template-layer {
            position: relative;
            flex-direction: column;
            width: 100%;
            min-height: 100%;
            margin: 1rem 0;
        }

        .template-layer>div.text-primary {
            padding: 0 0.4rem 0.4rem 0.4rem;

            &>.text {
                font-size: 1rem;
                font-weight: 500;
            }

            &>.long_text {
                font-size: 0.8rem;
                color: var(--color-long-text);
            }
        }

        .template-layer .content {
            padding: 0 1rem;
        }

        label.switch,
        .content>::part(template-widget) {
            display: flex;
            margin: 0.5rem 0;
            place-content: space-between;
        }

        .content [v-hide] {
            display: none !important;
        }
    </style>
    <div part="template-layer" class="template template-layer layer">
        <div class="text-primary">
            <div class="text"></div>
            <div class="long_text"></div>
        </div>
        <div class="content"></div>
    </div>
    <script>
        return function renderMainTitle(target, settings, options) {
            target.host?.classList.add("template-layer");
        }
    </script>
</template>


<template id="switch">
    <style>
        div.text-primary>.text {
            font-size: 1rem;
            font-weight: 500;
        }

        div.text-primary>.long_text {
            font-size: 0.8rem;
            color: var(--color-long-text);
        }

        .switch>.custom-button {
            position: relative;
            width: 44px;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin: auto 0;
        }

        .custom-button>.peer,
        .custom-button>.peer::before,
        .custom-button>.peer::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .custom-button>.peer::before {
            background-color: var(--background-switch);
            transition: background-color 200ms ease-in-out;
        }

        .custom-button>.peer::after {
            width: 20px;
            height: 20px;
            top: 2px;
            left: 2px;
            border-radius: 50%;
            transition: left 200ms ease-in-out;
            background-color: aliceblue;
        }

        .custom-button>input[type=checkbox]:checked+.peer::before {
            background-color: var(--background-switch-select);
        }

        .custom-button>input[type=checkbox]:checked+.peer::after {
            left: 22px;
        }
    </style>
    <div class="template template-widget">
        <label part="template-widget" class="switch">
            <div class="text-primary">
                <div class="text"></div>
                <div class="long_text"></div>
            </div>
            <div class="custom-button">
                <input type="checkbox">
                <div class="peer"></div>
            </div>
        </label>
    </div>
    <script>
        return function renderSwitch(target, settings, options) {
            const psid = options.psid;
            const input = target.querySelector("input");
            input.checked = settings[psid];
            input.addEventListener("change", function () {
                MainUI.onchange(psid, this.type, this.checked);
                if (MainUI.map.has(psid)) {
                    Array.from(MainUI.map.get(psid)).forEach(value => {
                        MainUI.autoShow(...value)
                    })
                }
            }, false);
        }
    </script>
</template>


<template id="input">
    <style>
        .template-widget.input {
            flex-direction: column;
        }
    </style>
    <div part="template-widget" class="template template-widget input">
        <!-- import template button -->
        <div class="custom-input">
            <input type="txet">
        </div>
    </div>
    <script>
        return function renderSubTitle(target, settings, options) {
            PuSet.get("button").init(false, function (root, view) {
                PuSet.populateContent(root, settings, options);
                const template_widget = target.querySelector(".template-widget");
                const input = template_widget.querySelector("input");

                template_widget.insertBefore(root.host, template_widget.firstElementChild);

                const button = root.querySelector("input");
                button.value = options.value;
                button.addEventListener("click", function () {
                    MainUI.onchange(psid, input.type, input.value);
                }, false);
            });
        }
    </script>
</template>


<template id="button">
    <style>



    </style>
    <label part="template-widget" class="template template-widget button">
        <div class="text-primary">
            <div class="text"></div>
            <div class="long_text"></div>
        </div>
        <div class="custom-button">
            <input type="button" value="OK">
        </div>
    </label>
    <script>
        return function renderButton(target, settings, options) {
            const psid = options.psid;
            const button = target.querySelector("input");
            button.value = options.value;
            button.addEventListener("click", function () {
                MainUI.onchange(psid, this.type, this.value);
            }, false);
        }
    </script>
</template>


<template id="file">
    <style>
        .template-widget.file {
            flex-direction: column;
        }
    </style>
    <div part="template-widget" class="template template-widget file">
        <div class="text-primary">
            <div class="text"></div>
            <div class="long_text"></div>
        </div>
        <div class="content">
            <label class="custom-button file">
                <input type="file" value="OK">
                <div class="view">
                    <img src="/mediae/icons/update.png" alt="select">
                    <p class="mb-1 text-sm text-neutral-600">
                        <span class="font-semibold">点击选择文件</span>
                        <span>或</span>
                        <span class="font-semibold">拖入文件</span>
                    </p>
                </div>
            </label>
        </div>
    </div>
    <script>
        function readAsDataURL(psid, list) {
            if (list && list.length > 0) {
                const fr = new FileReader();
                fr.onload = () => MainUI.onchange(psid, "file", fr.result);
                fr.readAsDataURL(list.item(0));
            }
        }
        return function renderLocalFile(target, settings, options) {
            const fileBox = target.querySelector(".custom-button.file");
            PuSet(fileBox).on({
                "change": function (event) {
                    readAsDataURL(options.psid, event.target.files);
                },
                "dragenter dragover dragleave": function (event) {
                    event.preventDefault();
                },
                "drop": function (event) {
                    event.preventDefault();
                    readAsDataURL(options.psid, event.dataTransfer.files);
                }
            });
        }
    </script>
</template>


<template id="object-list">
    <style>
        .template-widget {
            flex-direction: column;
        }

        .template-widget>ul.content {
            padding: 0;
        }
    </style>
    <div part="template-widget" class="template template-widget object-list">
        <!-- import template button -->
        <ul class="content flex-vertical">
            <li class="flex-horizontal">
                <span class="index"></span>
                <span class="text"></span>
            </li>
        </ul>
    </div>
    <script>
        return function renderObjectList(target, settings, options) {
            "use strict";
            PuSet.get("button").init(false, function (root, view) {
                PuSet.populateContent(root, settings, options);
                view.exec(root, settings, options);
                const template_widget = target.querySelector(".template-widget");
                template_widget.insertBefore(root.host, template_widget.firstElementChild);
            });
            PuSet.ViewManager({
                target: target.querySelector("ul.content"),
                selector: "li",
                list: settings[options.value],
                data: settings[options.psid],
                layout(target, value, key) {
                    const index = 1 + this.list.indexOf(key);
                    target.dataset.psid = key;
                    target.dataset.index = target.style.order = index === 0 ? 999 : index;
                    target.querySelector(".text").textContent = value.title;
                }
            });
        }
    </script>
</template>


<template id="image-list">
    <style>
        div.image-list {
            flex-direction: column;
        }

        label.template-widget {
            margin: 0;
        }

        ul.content {
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        ul.content>* {
            position: relative;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            border-radius: 0.5rem;
            background-color: #000;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
        }

        video {
            pointer-events: none;
            touch-action: none;
        }
    </style>
    <ul class="content grid-horizontal unify">
        <div>
            <video class="view" muted preload="metadata"
                poster="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></video>
            <label class="view custom-button file">
                <input type="file" value="OK">
                <div class="view">
                    <img src="/mediae/icons/update.png" alt="select">
                    <p class="mb-1 text-sm text-neutral-600">
                        <span class="font-semibold">点击选择文件</span>
                        <span>或</span>
                        <span class="font-semibold">拖入文件</span>
                    </p>
                </div>
            </label>
        </div>
        <li>
            <video class="view" muted preload="metadata"
                poster="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></video>
        </li>
    </ul>
    <script>
        function readAsDataURL(psid, list) {
            if (list && list.length > 0) {
                const file = list.item(0);
                storage.setItem("puset-local-wallpaper", file).then(function () {
                    MainUI.onchange(psid, "file", URL.createObjectURL(file));
                });
            }
        }
        return function renderImageList(target, settings, options) {
            "use strict";
            return PuSet.get("switch").init(true, function (root, view) {
                root.querySelector("div.template").appendChild(target);
                PuSet.populateContent(root, settings, options);
                view.exec(root, settings, options);
                const checkbox = root.querySelector("input");
                const content = root.querySelector("ul.content");
                checkbox.addEventListener("change", () => PuSet.show(content, checkbox.checked));
                PuSet.ViewManager({
                    target: content,
                    selector: "li",
                    data: options.list,
                    delegation: {
                        "click": function backgroundImageListItemClick(event, value) {
                            checkbox.checked = true;
                            settings.string_background_src = value.s;
                            MainUI.onchange(psid, value.t, value.s);
                        },
                        "pointerover": function pointerenter() {
                            /** @type {HTMLVideoElement} */
                            const video = this.querySelector("video");
                            if (video.readyState > 2) {
                                video.play();
                            }
                        },
                        "pointerout": function pointerleave() {
                            this.querySelector("video").pause();
                        }
                    },
                    layout(li, value, key) {
                        li.title = value.t;
                        li.style.setProperty("background-image", `url(${value.p || value.s})`);
                        if (value.t.startsWith("video")) {
                            li.querySelector("video").src = value.s;
                        } else {
                            li.querySelector("video").removeAttribute("src");
                        }
                    }
                });
                PuSet(".custom-button.file").on({
                    "change": function (event) {
                        checkbox.checked = true;
                        readAsDataURL(psid, event.target.files);
                    },
                    "dragenter dragover dragleave": function (event) {
                        event.preventDefault();
                    },
                    "drop": function (event) {
                        event.preventDefault();
                        checkbox.checked = true;
                        readAsDataURL(psid, event.dataTransfer.files);
                    }
                });
                return root;
            });
        }
    </script>
</template>


<template id="radio-list">
    <style>
        .template-widget {
            flex-direction: column;
        }

        .grid-horizontal {
            position: relative;
            grid-template-columns: 4rem;
            grid-auto-flow: column;
            padding: 0.4rem 0;
            justify-content: space-between;
        }

        .custom-radio {
            position: relative;
            border: 1px solid #898989;
            padding: 0.3rem;
            border-radius: 8px;
            min-width: 4rem;
            overflow: hidden;
        }

        input[type=radio]+div {
            place-content: center;
            place-items: center;
            text-align: center;
            border-radius: 8px;
            font-weight: 500;
        }

        input[type=radio]:checked+div {
            color: var(--background-switch-select);
        }
    </style>
    <div part="template-widget" class="template template-widget">
        <div class="text-primary">
            <div class="text"></div>
            <div class="long_text"></div>
        </div>
        <div class="grid-horizontal">
            <label class="custom-radio">
                <input type="radio">
                <div class="view text">default</div>
            </label>
        </div>
    </div>
    <script>
        return function renderRadioList(target, settings, options) {
            "use strict";
            const psid = options.psid;
            PuSet.ViewManager({
                target: target.querySelector(".template-widget>.grid-horizontal"),
                selector: "label.custom-radio",
                data: options.list,
                layout: function (label, value, key) {
                    const input = label.querySelector("input");
                    input.name = psid;
                    input.value = key;
                    input.checked = (key === settings[options.value]);

                    const text = label.querySelector(".text");
                    text.textContent = label.dataset.psid = key;
                    text.style.background = value;
                }
            }).target.addEventListener("change", function (event) {
                const input = event.target;
                if (input.name === psid) {
                    MainUI.onchange(psid, input.type, input.value);
                }
            });
        }
    </script>
</template>